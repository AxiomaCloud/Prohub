// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTENTICACIÓN Y USUARIOS
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String
  phone         String?
  avatar        String?
  emailVerified Boolean   @default(false)
  superuser     Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Multi-tenant
  tenantMemberships TenantMembership[]

  // Actividad
  uploadedDocuments  Document[]       @relation("UploadedDocuments")
  documentEvents     DocumentEvent[]
  comments           Comment[]

  // Purchase Requests
  purchaseRequests   PurchaseRequest[] @relation("PurchaseRequestSolicitante")
  purchaseRequestsAprobados PurchaseRequest[] @relation("PurchaseRequestAprobador")
  attachmentsAprobados PurchaseRequestAttachment[]

  // RFQ / Cotizaciones
  createdRFQs        QuotationRequest[] @relation("CreatedRFQs")

  @@index([email])
}

model Tenant {
  id          String   @id @default(cuid())
  name        String
  legalName   String
  taxId       String   @unique // CUIT, RUT, etc.
  country     String
  address     String?
  phone       String?
  email       String?
  website     String?
  settings    Json     @default("{}")
  branding    Json?    // Logo, colores personalizados
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  memberships TenantMembership[]

  // Como cliente (recibe documentos)
  documentsReceived Document[]       @relation("ClientDocuments")
  purchaseOrders    PurchaseOrder[]
  paymentsIssued    Payment[]

  // Como proveedor (envía documentos)
  documentsSent     Document[]       @relation("ProviderDocuments")
  paymentsReceived  Payment[]        @relation("ReceivedPayments")

  // Menu items personalizados
  menuItems         MenuItem[]

  // Purchase Requests
  purchaseRequests  PurchaseRequest[]

  @@index([taxId])
  @@index([isActive])
}

model TenantMembership {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String
  roles     Role[]
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata de invitación
  invitedBy String?
  invitedAt DateTime?
  joinedAt  DateTime?

  // Vinculación a proveedor (para usuarios con rol PROVIDER)
  supplierId String?
  supplier   Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)

  @@unique([userId, tenantId])
  @@index([userId])
  @@index([tenantId])
  @@index([supplierId])
}

enum Role {
  PROVIDER              // Puede cargar documentos
  CLIENT_VIEWER         // Solo ver documentos
  CLIENT_APPROVER       // Aprobar/rechazar documentos
  CLIENT_ADMIN          // Gestión completa
  SUPER_ADMIN           // Admin global del sistema
  // Roles de Compras
  PURCHASE_REQUESTER    // Puede crear requerimientos de compra
  PURCHASE_APPROVER     // Puede aprobar requerimientos de compra
  PURCHASE_ADMIN        // Gestión completa del circuito de compras
}

// ============================================
// DOCUMENTOS
// ============================================

model Document {
  id        String   @id @default(cuid())
  number    String
  type      DocumentType
  status    DocumentStatus

  // Montos
  amount      Decimal
  taxAmount   Decimal
  totalAmount Decimal
  currency    String   @default("ARS")

  // Archivo
  fileUrl     String
  fileName    String
  fileType    String
  fileSize    Int

  // Multi-tenant
  providerTenantId String?
  providerTenant   Tenant? @relation("ProviderDocuments", fields: [providerTenantId], references: [id])

  clientTenantId   String
  clientTenant     Tenant @relation("ClientDocuments", fields: [clientTenantId], references: [id])

  // Usuario que subió
  uploadedBy       String
  uploader         User   @relation("UploadedDocuments", fields: [uploadedBy], references: [id])

  // Fechas
  date             DateTime?  // Fecha del documento
  dueDate          DateTime?  // Fecha de vencimiento
  uploadedAt       DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  // Parse integration
  parseJobId       String?
  parseDocumentId  String?      // ID del documento en Parse (documentos_procesados.id)
  parseStatus      ParseStatus  @default(PENDING)
  parseData        Json?
  parseConfidence  Decimal?
  parseError       String?
  parseRawText     String?      @db.Text
  parsedAt         DateTime?

  // Estado de envío del proveedor (para workflow de borradores)
  submissionStatus DocumentSubmissionStatus @default(SUBMITTED)
  submittedAt      DateTime?    // Fecha cuando el proveedor marcó como definitivo

  // Relaciones
  purchaseOrderId  String?
  purchaseOrder    PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])

  timeline         DocumentEvent[]
  comments         Comment[]
  attachments      Attachment[]
  paymentItems     PaymentItem[]

  @@unique([number, providerTenantId, clientTenantId])
  @@index([providerTenantId, clientTenantId, status])
  @@index([clientTenantId, status, uploadedAt])
  @@index([parseStatus])
  @@index([submissionStatus])
  @@index([clientTenantId, submissionStatus]) // Para filtrar docs enviados al tenant
}

enum DocumentType {
  INVOICE
  CREDIT_NOTE
  DEBIT_NOTE
  RECEIPT
}

enum DocumentStatus {
  PROCESSING   // Subido, esperando Parse
  PRESENTED    // Presentado, esperando revisión
  IN_REVIEW    // En proceso de revisión
  APPROVED     // Aprobado
  PAID         // Pagado
  REJECTED     // Rechazado
}

enum ParseStatus {
  PENDING
  PROCESSING
  COMPLETED
  ERROR
}

// Estado de envío del documento (para facturas subidas por proveedores)
enum DocumentSubmissionStatus {
  DRAFT       // Borrador - solo visible para el proveedor
  SUBMITTED   // Enviado - visible para el tenant/cliente
}

model DocumentEvent {
  id          String   @id @default(cuid())
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  fromStatus  DocumentStatus?
  toStatus    DocumentStatus
  reason      String?
  metadata    Json?

  userId      String
  user        User     @relation(fields: [userId], references: [id])

  createdAt   DateTime @default(now())

  @@index([documentId, createdAt])
}

model Comment {
  id          String   @id @default(cuid())
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  userId      String
  user        User     @relation(fields: [userId], references: [id])

  text        String   @db.Text
  attachments Attachment[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([documentId, createdAt])
}

model Attachment {
  id         String   @id @default(cuid())
  fileUrl    String
  fileName   String
  fileType   String
  fileSize   Int

  documentId String?
  document   Document? @relation(fields: [documentId], references: [id], onDelete: Cascade)

  commentId  String?
  comment    Comment?  @relation(fields: [commentId], references: [id], onDelete: Cascade)

  uploadedAt DateTime @default(now())

  @@index([documentId])
  @@index([commentId])
}

// ============================================
// MENU DINÁMICO
// ============================================

model MenuItem {
  id                 String       @id @default(cuid())
  parentId           String?
  title              String       @db.VarChar(100)
  icon               String       @db.VarChar(50)
  url                String?      @db.VarChar(255)
  description        String?      @db.VarChar(500)
  orderIndex         Int          @default(0)
  isActive           Boolean      @default(true)
  requiresPermission String?      @db.VarChar(100)  // Deprecated - usar allowedRoles
  allowedRoles       Role[]       @default([])      // Roles que pueden ver este item (vacío = todos)
  superuserOnly      Boolean      @default(false)
  tenantId           String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  createdBy          String?
  updatedBy          String?

  parent             MenuItem?    @relation("MenuHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children           MenuItem[]   @relation("MenuHierarchy")
  tenant             Tenant?      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([orderIndex])
  @@index([parentId])
  @@index([superuserOnly])
  @@index([tenantId])
  @@map("menu_items")
}

// ============================================
// ÓRDENES DE COMPRA (CIRCUITO DE COMPRAS)
// ============================================

model PurchaseOrderCircuit {
  id                String    @id @default(cuid())
  numero            String    // OC-2025-XXXXX

  // Vínculo con el requerimiento (one-to-many: un requerimiento puede tener múltiples OCs)
  purchaseRequestId String
  purchaseRequest   PurchaseRequest @relation(fields: [purchaseRequestId], references: [id])

  // Proveedor
  proveedorId       String
  proveedor         Supplier  @relation(fields: [proveedorId], references: [id])

  // Estado
  estado            PurchaseOrderCircuitStatus @default(PENDIENTE_APROBACION)

  // Montos
  subtotal          Decimal   @db.Decimal(18,2)
  impuestos         Decimal   @db.Decimal(18,2) @default(0)
  total             Decimal   @db.Decimal(18,2)
  moneda            String    @default("ARS")

  // Condiciones
  condicionPago     String?
  lugarEntrega      String?
  observaciones     String?   @db.Text

  // Fechas
  fechaEmision      DateTime  @default(now())
  fechaEntregaEstimada DateTime?

  // Multi-tenant
  tenantId          String

  // Usuario que creó la OC
  creadoPorId       String

  // Aprobación de OC
  aprobadorOCId     String?
  fechaAprobacionOC DateTime?
  comentarioAprobacionOC String? @db.Text

  // Items
  items             PurchaseOrderItem[]

  // Recepciones
  recepciones       Reception[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([numero, tenantId])
  @@index([tenantId, estado])
  @@index([purchaseRequestId])
  @@index([proveedorId])
  @@map("purchase_order_circuits")
}

model PurchaseOrderItem {
  id                  String    @id @default(cuid())
  purchaseOrderId     String
  purchaseOrder       PurchaseOrderCircuit @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  // Referencia al item original del requerimiento
  purchaseRequestItemId String?
  purchaseRequestItem   PurchaseRequestItem? @relation(fields: [purchaseRequestItemId], references: [id])

  descripcion         String
  cantidad            Decimal   @db.Decimal(18,4)
  cantidadRecibida    Decimal   @db.Decimal(18,4) @default(0)
  unidad              String    @default("Unidad")
  precioUnitario      Decimal   @db.Decimal(18,4)
  total               Decimal   @db.Decimal(18,4)

  createdAt           DateTime  @default(now())

  // Items recibidos en recepciones
  itemsRecibidos      ReceptionItem[]

  @@index([purchaseOrderId])
  @@index([purchaseRequestItemId])
  @@map("purchase_order_items")
}

enum PurchaseOrderCircuitStatus {
  PENDIENTE_APROBACION
  APROBADA
  RECHAZADA
  EN_PROCESO
  PARCIALMENTE_RECIBIDA
  ENTREGADA
  FINALIZADA
  CANCELADA
}

// ============================================
// PROVEEDORES
// ============================================

model Supplier {
  id          String    @id @default(cuid())
  tenantId    String
  userId      String?   // Usuario vinculado (para acceso al portal)

  // Datos básicos
  nombre          String        // Razón Social
  nombreFantasia  String?       // Nombre de fantasía
  cuit            String

  // Estado del proveedor
  status          SupplierStatus @default(INVITED)

  // Condición fiscal
  condicionFiscal CondicionFiscal?
  tipoFactura     TipoFactura?

  // Domicilio fiscal
  direccion       String?
  numero          String?
  piso            String?
  localidad       String?
  provincia       String?
  codigoPostal    String?
  pais            String?       @default("Argentina")

  // Contacto
  telefono        String?
  whatsapp        String?
  email           String?
  emailFacturacion String?
  contactoNombre  String?
  contactoCargo   String?

  // Datos bancarios
  banco           String?
  tipoCuenta      TipoCuentaBancaria?
  numeroCuenta    String?
  cbu             String?
  alias           String?
  titularCuenta   String?
  cuitTitular     String?
  monedaCuenta    String?       @default("ARS")

  // Preferencias de notificaciones
  notifEmail      Boolean       @default(true)
  notifWhatsapp   Boolean       @default(false)
  notifSms        Boolean       @default(false)
  notifDocStatus  Boolean       @default(true)
  notifPagos      Boolean       @default(true)
  notifComentarios Boolean      @default(true)
  notifOC         Boolean       @default(false)

  // Configuración de procesamiento de documentos
  useAIParse      Boolean       @default(false)  // Si usa IA (Axio) para extraer datos de facturas

  // Metadata de onboarding
  invitadoPor     String?
  invitadoAt      DateTime?
  completoOnboarding Boolean    @default(false)
  onboardingCompletadoAt DateTime?
  aprobadoPor     String?
  aprobadoAt      DateTime?
  motivoRechazo   String?

  isActive        Boolean       @default(true)

  // Relaciones
  documentos      SupplierDocument[]
  cuentasBancarias SupplierBankAccount[]
  ordenesCompra   PurchaseOrderCircuit[]

  // RFQ - Cotizaciones
  rfqInvitations  QuotationRequestSupplier[]
  quotations      SupplierQuotation[]
  awardedRFQs     QuotationRequest[] @relation("AwardedRFQs")

  // Usuarios del proveedor (múltiples usuarios pueden pertenecer al mismo proveedor)
  userMemberships TenantMembership[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([tenantId, cuit])
  @@index([tenantId, isActive])
  @@index([tenantId, status])
  @@map("suppliers")
}

enum SupplierStatus {
  INVITED             // Email enviado, esperando registro
  PENDING_COMPLETION  // Registrado, formularios incompletos
  PENDING_APPROVAL    // Formularios completos, esperando validación
  ACTIVE              // Aprobado por el cliente
  SUSPENDED           // Temporalmente deshabilitado
  REJECTED            // No aprobado por el cliente
}

enum CondicionFiscal {
  RESPONSABLE_INSCRIPTO
  MONOTRIBUTISTA
  EXENTO
  NO_RESPONSABLE
  CONSUMIDOR_FINAL
}

enum TipoFactura {
  A
  B
  C
  E   // Exportación
}

enum TipoCuentaBancaria {
  CUENTA_CORRIENTE
  CAJA_AHORRO
}

// Documentos del proveedor (constancias, certificados)
model SupplierDocument {
  id          String    @id @default(cuid())
  supplierId  String
  supplier    Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  tipo        SupplierDocumentType
  nombre      String
  fileUrl     String
  fileName    String
  fileType    String
  fileSize    Int

  // Validez
  fechaEmision    DateTime?
  fechaVencimiento DateTime?

  // Estado
  status      SupplierDocumentStatus @default(PENDING)
  validadoPor String?
  validadoAt  DateTime?
  observacion String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([supplierId])
  @@map("supplier_documents")
}

enum SupplierDocumentType {
  CONSTANCIA_CBU
  CONSTANCIA_CUIT
  CONSTANCIA_AFIP
  CONSTANCIA_IIBB
  CERTIFICADO_RETENCION
  CERTIFICADO_FISCAL
  OTRO
}

enum SupplierDocumentStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

// Cuentas bancarias del proveedor
model SupplierBankAccount {
  id          String    @id @default(cuid())
  supplierId  String
  supplier    Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  banco           String        // Código del banco (BANCO_NACION, BANCO_GALICIA, etc.)
  tipoCuenta      TipoCuentaBancaria
  numeroCuenta    String?
  cbu             String
  alias           String?
  titularCuenta   String
  moneda          String        @default("ARS")
  esPrincipal     Boolean       @default(false)

  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([supplierId])
  @@map("supplier_bank_accounts")
}

// Configuración de onboarding por tenant
model TenantSupplierConfig {
  id          String    @id @default(cuid())
  tenantId    String    @unique

  // Campos requeridos - Datos bancarios
  reqConstanciaCBU      Boolean @default(true)
  reqTitularCoincide    Boolean @default(true)

  // Campos requeridos - Datos fiscales
  reqConstanciaAFIP     Boolean @default(true)
  reqConstanciaIIBB     Boolean @default(false)
  reqCertificadoRetencion Boolean @default(false)

  // Campos requeridos - Contacto
  reqEmailFacturacion   Boolean @default(false)
  reqWhatsapp           Boolean @default(false)
  reqTelefonoAlt        Boolean @default(false)

  // Modo de aprobación
  aprobacionAutomatica  Boolean @default(false)  // Si true, se activa inmediatamente

  // Mensajes personalizados
  mensajeBienvenida     String? @db.Text
  mensajeAprobacion     String? @db.Text
  mensajeRechazo        String? @db.Text

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("tenant_supplier_configs")
}

// ============================================
// RECEPCIONES
// ============================================

model Reception {
  id                String    @id @default(cuid())
  numero            String    // REC-2025-XXXXX

  // Vínculos
  purchaseOrderId   String
  purchaseOrder     PurchaseOrderCircuit @relation(fields: [purchaseOrderId], references: [id])

  // Receptor
  receptorId        String

  // Datos de recepción
  fechaRecepcion    DateTime  @default(now())
  tipoRecepcion     ReceptionType @default(TOTAL)
  observaciones     String?   @db.Text

  // Multi-tenant
  tenantId          String

  // Items recibidos
  itemsRecibidos    ReceptionItem[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([numero, tenantId])
  @@index([tenantId])
  @@index([purchaseOrderId])
  @@map("receptions")
}

model ReceptionItem {
  id                String    @id @default(cuid())
  receptionId       String
  reception         Reception @relation(fields: [receptionId], references: [id], onDelete: Cascade)

  // Vínculo con item de OC
  purchaseOrderItemId String
  purchaseOrderItem   PurchaseOrderItem @relation(fields: [purchaseOrderItemId], references: [id])

  descripcion       String
  unidad            String
  cantidadEsperada  Decimal   @db.Decimal(18,4)
  cantidadRecibida  Decimal   @db.Decimal(18,4)
  cantidadPendiente Decimal   @db.Decimal(18,4)

  createdAt         DateTime  @default(now())

  @@index([receptionId])
  @@index([purchaseOrderItemId])
  @@map("reception_items")
}

enum ReceptionType {
  TOTAL
  PARCIAL
}

// ============================================
// ÓRDENES DE COMPRA (LEGACY - para documentos)
// ============================================

model PurchaseOrder {
  id             String    @id @default(cuid())
  number         String
  description    String?
  amount         Decimal
  currency       String    @default("ARS")
  status         PurchaseOrderStatus

  clientTenantId String
  clientTenant   Tenant    @relation(fields: [clientTenantId], references: [id])

  // Fechas
  date           DateTime
  dueDate        DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Archivo
  fileUrl        String?
  fileName       String?

  // Relaciones
  documents      Document[]

  @@unique([number, clientTenantId])
  @@index([clientTenantId, status])
}

enum PurchaseOrderStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

// ============================================
// PAGOS
// ============================================

model Payment {
  id              String   @id @default(cuid())
  number          String
  amount          Decimal
  currency        String   @default("ARS")
  status          PaymentStatus

  // Tenant que emite el pago
  issuedByTenantId String
  issuedByTenant   Tenant @relation(fields: [issuedByTenantId], references: [id])

  // Tenant que recibe el pago
  receivedByTenantId String
  receivedByTenant   Tenant @relation("ReceivedPayments", fields: [receivedByTenantId], references: [id])

  // Fechas
  issueDate       DateTime
  scheduledDate   DateTime?
  paidAt          DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Archivos
  receiptUrl      String?
  retentionUrls   Json?     // Array de URLs de retenciones

  // Documentos incluidos en el pago
  items           PaymentItem[]

  @@unique([number, issuedByTenantId])
  @@index([issuedByTenantId, status])
  @@index([receivedByTenantId, status])
}

enum PaymentStatus {
  SCHEDULED
  PROCESSING
  PAID
  FAILED
}

model PaymentItem {
  id         String  @id @default(cuid())
  paymentId  String
  payment    Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  documentId String
  document   Document @relation(fields: [documentId], references: [id])

  amount     Decimal

  @@index([paymentId])
  @@index([documentId])
}

// ============================================
// COMUNICACIONES
// ============================================

model Conversation {
  id              String   @id @default(cuid())
  subject         String
  status          ConversationStatus
  channel         CommunicationChannel

  // Participantes
  providerTenantId String?
  clientTenantId   String

  createdById     String
  closedById      String?

  // Vinculación polimórfica con documentos
  documentType            DocumentChatType?
  linkedDocumentId        String?
  linkedPurchaseOrderId   String?
  linkedPurchaseRequestId String?
  linkedQuotationId       String?
  linkedPaymentId         String?

  // Contadores de mensajes no leídos
  unreadCountProvider     Int @default(0)
  unreadCountClient       Int @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  closedAt        DateTime?

  messages        Message[]

  @@index([providerTenantId, clientTenantId])
  @@index([status])
  @@index([linkedDocumentId])
  @@index([linkedPurchaseOrderId])
  @@index([linkedPurchaseRequestId])
  @@index([linkedQuotationId])
  @@index([linkedPaymentId])
}

enum ConversationStatus {
  OPEN
  RESOLVED
  CLOSED
}

enum CommunicationChannel {
  PORTAL
  EMAIL
  WHATSAPP
  SMS
}

// Tipo de documento para chat bidireccional
enum DocumentChatType {
  DOCUMENT          // Facturas, NC, ND, Recibos
  PURCHASE_ORDER    // Órdenes de Compra
  PURCHASE_REQUEST  // Requerimientos
  QUOTATION         // Cotizaciones
  PAYMENT           // Pagos
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderId       String
  senderName     String?
  senderTenantId String?
  text           String       @db.Text
  channel        CommunicationChannel
  attachments    Json?        // [{fileName, fileUrl, fileType, fileSize}]

  readAt         DateTime?
  createdAt      DateTime     @default(now())

  @@index([conversationId, createdAt])
  @@index([senderId])
}

// ============================================
// NOTIFICACIONES
// ============================================

model Notification {
  id        String            @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String            @db.Text
  data      Json?
  channel   CommunicationChannel

  readAt    DateTime?
  sentAt    DateTime?
  createdAt DateTime          @default(now())

  @@index([userId, readAt])
}

enum NotificationType {
  DOCUMENT_UPLOADED
  DOCUMENT_PARSED
  DOCUMENT_STATUS_CHANGED
  PAYMENT_ISSUED
  MESSAGE_RECEIVED
  APPROVAL_REQUIRED
}

// ============================================
// MÓDULO DE COMPRAS - REQUERIMIENTOS
// ============================================

model PurchaseRequest {
  id          String                @id @default(cuid())
  numero      String                // REQ-2025-XXXXX (único por tenant)
  titulo      String                // Título corto generado del primer item

  // Estado
  estado      PurchaseRequestStatus @default(BORRADOR)
  prioridad   PurchaseRequestPriority @default(NORMAL)

  // Tipo de compra (para determinar regla de aprobación)
  purchaseType  PurchaseType          @default(DIRECT)

  // Switch de aprobación de especificaciones
  requiresSpecApproval  Boolean       @default(false)
  specsApproved         Boolean       @default(false)  // True cuando las especificaciones fueron aprobadas

  // Datos del requerimiento
  categoria     String                // Tecnología, Oficina, Servicios, etc.
  centroCostos  String?               // Centro de costos
  descripcion   String?               @db.Text  // Descripción breve del requerimiento
  justificacion String?               @db.Text  // Observaciones adicionales

  // Montos
  montoEstimado Decimal?            // Presupuesto estimado
  currency      String              @default("ARS")

  // Multi-tenant
  tenantId    String
  tenant      Tenant                @relation(fields: [tenantId], references: [id])

  // Usuario solicitante
  solicitanteId String
  solicitante   User                @relation("PurchaseRequestSolicitante", fields: [solicitanteId], references: [id])

  // Aprobación
  aprobadorId         String?
  aprobador           User?          @relation("PurchaseRequestAprobador", fields: [aprobadorId], references: [id])
  fechaAprobacion     DateTime?
  comentarioAprobador String?        @db.Text

  // Items del requerimiento
  items       PurchaseRequestItem[]

  // Adjuntos
  adjuntos    PurchaseRequestAttachment[]

  // Órdenes de compra generadas (puede haber múltiples OCs por requerimiento)
  ordenesCompra PurchaseOrderCircuit[]

  // Solicitudes de cotización generadas
  quotationRequests QuotationRequest[]

  // Chat interno (solicitante <-> aprobadores)
  chat              PurchaseRequestChat?

  // Metadata del chatbot (si fue creado por IA)
  creadoPorIA Boolean               @default(false)
  promptOriginal String?            @db.Text // Comando original del usuario

  // Fechas
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  fechaNecesidad DateTime?             // Fecha en que se necesita
  fechaEnvio     DateTime?             // Fecha de envío a aprobación

  @@index([tenantId, estado])
  @@index([solicitanteId])
  @@unique([tenantId, numero])
}

model PurchaseRequestItem {
  id                String         @id @default(cuid())
  purchaseRequestId String
  purchaseRequest   PurchaseRequest @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)

  descripcion       String
  cantidad          Decimal        @db.Decimal(18,4)
  especificaciones  String?        @db.Text // JSON array de specs

  unidadMedida      String?        // unidad, paquete, servicio, etc.
  precioEstimado    Decimal?       @db.Decimal(18,4)

  createdAt         DateTime       @default(now())

  // Items de OC que referencian este item
  ordenCompraItems  PurchaseOrderItem[]

  @@index([purchaseRequestId])
}

model PurchaseRequestAttachment {
  id                String         @id @default(cuid())
  purchaseRequestId String
  purchaseRequest   PurchaseRequest @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)

  nombre            String
  tipo              String         // MIME type
  tamanio           Int            // Tamaño en bytes
  url               String         // URL del archivo

  esEspecificacion  Boolean        @default(false) // Es documento de especificaciones técnicas
  estado            AttachmentStatus @default(PENDIENTE)

  // Aprobación de especificación
  aprobadorId       String?
  aprobador         User?          @relation(fields: [aprobadorId], references: [id])
  fechaAprobacion   DateTime?
  comentario        String?

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([purchaseRequestId])
  @@map("purchase_request_attachments")
}

enum AttachmentStatus {
  PENDIENTE
  APROBADO
  RECHAZADO
}

enum PurchaseRequestStatus {
  BORRADOR
  PENDIENTE_APROBACION
  ENVIADO
  EN_REVISION
  APROBADO
  RECHAZADO
  OC_GENERADA
  RECIBIDO
  CANCELADO
}

enum PurchaseRequestPriority {
  BAJA
  NORMAL
  ALTA
  URGENTE
}

// Tipo de compra (para determinar regla de aprobación)
enum PurchaseType {
  DIRECT          // Compra directa (sin cotización)
  WITH_QUOTE      // Con cotización
  WITH_BID        // Con licitación
  WITH_ADVANCE    // Con anticipo
}

// ============================================
// SISTEMA DE NOTIFICACIONES - PREFERENCIAS
// ============================================

model UserNotificationPreference {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String

  eventType NotificationEventType
  documentType DocumentNotificationType?

  emailEnabled    Boolean @default(true)
  portalEnabled   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, tenantId, eventType, documentType])
  @@index([userId, tenantId])
  @@map("user_notification_preferences")
}

enum NotificationEventType {
  // Requerimientos
  REQ_SUBMITTED
  REQ_APPROVED
  REQ_REJECTED
  REQ_NEEDS_APPROVAL

  // Órdenes de Compra
  OC_GENERATED
  OC_NEEDS_APPROVAL
  OC_APPROVED
  OC_REJECTED

  // Recepciones
  RECEPTION_REGISTERED
  RECEPTION_COMPLETE

  // Delegaciones
  DELEGATION_RECEIVED
  DELEGATION_EXPIRED

  // Documentos
  DOC_UPLOADED
  DOC_STATUS_CHANGED
  DOC_APPROVED
  DOC_REJECTED
  DOC_COMMENT

  // Proveedores
  SUPPLIER_INVITED
  SUPPLIER_APPROVED
  SUPPLIER_REJECTED
  SUPPLIER_PENDING_APPROVAL

  // Pagos
  PAYMENT_ISSUED
  PAYMENT_COMPLETED
  PAYMENT_SCHEDULED

  // RFQ (Cotizaciones)
  RFQ_INVITATION
  RFQ_AWARDED
  RFQ_NOT_AWARDED
  RFQ_QUOTATION_RECEIVED
  RFQ_DEADLINE_REMINDER

  // Ordenes de Compra
  OC_SUPPLIER_NOTIFIED

  // Chat de documentos
  DOC_MESSAGE_RECEIVED
}

enum DocumentNotificationType {
  PURCHASE_REQUEST
  PURCHASE_ORDER
  RECEPTION
  ALL
}

// ============================================
// SISTEMA DE NOTIFICACIONES - PLANTILLAS EMAIL
// ============================================

model EmailTemplate {
  id        String   @id @default(cuid())
  tenantId  String?

  eventType NotificationEventType

  subject   String
  bodyHtml  String   @db.Text
  bodyText  String?  @db.Text

  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, eventType])
  @@map("email_templates")
}

// ============================================
// SISTEMA DE NOTIFICACIONES - COLA DE EMAILS
// ============================================

model EmailQueue {
  id          String   @id @default(cuid())

  toEmail     String
  toName      String?

  subject     String
  bodyHtml    String   @db.Text
  bodyText    String?  @db.Text

  eventType   NotificationEventType
  relatedId   String?
  relatedType String?
  tenantId    String?

  priority    Int      @default(0)  // Higher = more urgent
  status      EmailQueueStatus @default(PENDING)
  attempts    Int      @default(0)
  maxAttempts Int      @default(3)
  lastError   String?
  sentAt      DateTime?

  scheduledFor DateTime @default(now())

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status, scheduledFor])
  @@index([status, priority])
  @@map("email_queue")
}

enum EmailQueueStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
  CANCELLED
}

// ============================================
// SISTEMA DE AUTORIZACIONES - REGLAS
// ============================================

model ApprovalRule {
  id          String   @id @default(cuid())
  tenantId    String

  name        String
  description String?

  // Tipo de documento al que aplica
  documentType    ApprovalDocumentType @default(PURCHASE_REQUEST)

  // Condiciones para aplicar esta regla
  purchaseType    PurchaseType?
  minAmount       Decimal?          @db.Decimal(18,2)
  maxAmount       Decimal?          @db.Decimal(18,2)
  category        String?

  // Prioridad (mayor = se evalúa primero)
  priority    Int      @default(0)
  isActive    Boolean  @default(true)

  // Niveles de aprobación
  levels      ApprovalLevel[]

  // Auditoría IA
  creadoPorIA     Boolean   @default(false)
  promptOriginal  String?   @db.Text
  creadoPorId     String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId, isActive, priority])
  @@index([tenantId, documentType])
  @@map("approval_rules")
}

// ============================================
// SISTEMA DE AUTORIZACIONES - NIVELES
// ============================================

model ApprovalLevel {
  id              String   @id @default(cuid())
  approvalRuleId  String
  approvalRule    ApprovalRule @relation(fields: [approvalRuleId], references: [id], onDelete: Cascade)

  levelOrder      Int
  name            String

  // Modo: ANY = cualquiera aprueba (concurrente), ALL = todos aprueban (secuencial)
  approvalMode    ApprovalMode @default(ANY)

  // Tipo de nivel (general o especificaciones)
  levelType       ApprovalLevelType @default(GENERAL)

  // Aprobadores de este nivel
  approvers       ApprovalLevelApprover[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([approvalRuleId, levelOrder])
  @@map("approval_levels")
}

enum ApprovalMode {
  ANY   // Cualquiera de los aprobadores puede aprobar (OR)
  ALL   // Todos los aprobadores deben aprobar (AND)
}

enum ApprovalLevelType {
  GENERAL         // Aprobación general del documento
  SPECIFICATIONS  // Aprobación de especificaciones técnicas
}

// ============================================
// SISTEMA DE AUTORIZACIONES - APROBADORES POR NIVEL
// ============================================

model ApprovalLevelApprover {
  id                String   @id @default(cuid())
  approvalLevelId   String
  approvalLevel     ApprovalLevel @relation(fields: [approvalLevelId], references: [id], onDelete: Cascade)

  // Puede ser usuario específico o rol
  userId            String?
  role              Role?

  // Orden dentro del nivel (para modo ALL secuencial)
  sequenceOrder     Int      @default(0)

  createdAt         DateTime @default(now())

  @@map("approval_level_approvers")
}

// ============================================
// SISTEMA DE AUTORIZACIONES - WORKFLOW (instancia)
// ============================================

model ApprovalWorkflow {
  id              String   @id @default(cuid())

  // Documento asociado
  documentType    ApprovalDocumentType
  documentId      String
  tenantId        String

  // Regla que se aplicó
  approvalRuleId  String

  // Estado general del workflow
  status          ApprovalWorkflowStatus @default(PENDING)
  currentLevel    Int      @default(1)

  // Instancias de aprobación
  approvals       ApprovalInstance[]

  // Metadata
  initiatedBy     String
  initiatedAt     DateTime @default(now())
  completedAt     DateTime?

  // Resultado final
  finalDecision   ApprovalDecision?
  finalComment    String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([documentType, documentId])
  @@index([tenantId, status])
  @@map("approval_workflows")
}

enum ApprovalDocumentType {
  PURCHASE_REQUEST
  PURCHASE_ORDER
  INVOICE
}

enum ApprovalWorkflowStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
  CANCELLED
}

// ============================================
// SISTEMA DE AUTORIZACIONES - INSTANCIA DE APROBACIÓN
// ============================================

model ApprovalInstance {
  id              String   @id @default(cuid())
  workflowId      String
  workflow        ApprovalWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  // Nivel
  levelOrder      Int
  levelName       String
  levelType       ApprovalLevelType @default(GENERAL)
  approvalMode    ApprovalMode

  // Aprobadores potenciales (para registro en modo ANY)
  potentialApprovers Json?   // [{userId, role, name}]

  // Aprobador que tomó la decisión
  decidedById     String?
  decidedByName   String?

  // Decisión
  decision        ApprovalDecision @default(PENDING)
  comment         String?

  // Fechas
  assignedAt      DateTime @default(now())
  decidedAt       DateTime?
  dueDate         DateTime?

  // Delegación (si aplica)
  delegatedFromId String?
  delegatedAt     DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([workflowId, levelOrder])
  @@index([decidedById, decision])
  @@map("approval_instances")
}

enum ApprovalDecision {
  PENDING
  APPROVED
  REJECTED
  DELEGATED
  SKIPPED
}

// ============================================
// SISTEMA DE AUTORIZACIONES - DELEGACIONES
// ============================================

model ApprovalDelegation {
  id              String   @id @default(cuid())
  tenantId        String

  // Quien delega
  delegatorId     String
  delegatorName   String

  // A quien delega
  delegateId      String
  delegateName    String

  // Periodo de vigencia
  startDate       DateTime
  endDate         DateTime

  reason          String?
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId, delegatorId, isActive])
  @@index([delegateId, isActive])
  @@map("approval_delegations")
}

// ============================================
// SOLICITUDES DE COTIZACIÓN (RFQ)
// ============================================

model QuotationRequest {
  id              String   @id @default(cuid())
  number          String   // RFQ-2025-XXXXX
  title           String
  description     String?  @db.Text

  // Origen (opcional - puede venir de un requerimiento)
  purchaseRequestId String?
  purchaseRequest   PurchaseRequest? @relation(fields: [purchaseRequestId], references: [id])

  // Multi-tenant
  tenantId        String
  createdById     String

  // Estado
  status          RFQStatus @default(DRAFT)

  // Fechas
  deadline        DateTime          // Fecha límite para recibir cotizaciones
  deliveryDeadline DateTime?        // Fecha de entrega requerida

  // Condiciones
  paymentTerms    String?           // Condiciones de pago esperadas
  deliveryPlace   String?           // Lugar de entrega
  currency        String   @default("ARS")
  budget          Decimal? @db.Decimal(18,2) // Presupuesto estimado (opcional)

  // Notas adicionales
  notes           String?  @db.Text
  termsAndConditions String? @db.Text

  // Archivos adjuntos (especificaciones, planos, etc.)
  attachments     Json?    // [{fileName, fileUrl, fileType, fileSize}]

  // Fechas de workflow
  publishedAt     DateTime?
  closedAt        DateTime?
  awardedAt       DateTime?
  cancelledAt     DateTime?
  cancelReason    String?

  // Adjudicación
  awardedToId     String?
  awardedTo       Supplier? @relation("AwardedRFQs", fields: [awardedToId], references: [id])

  // Usuario que creó
  createdBy       User?    @relation("CreatedRFQs", fields: [createdById], references: [id])

  // Relaciones
  items           QuotationRequestItem[]
  invitedSuppliers QuotationRequestSupplier[]
  quotations      SupplierQuotation[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([tenantId, number])
  @@index([tenantId, status])
  @@index([status, deadline])
  @@index([purchaseRequestId])
  @@map("quotation_requests")
}

enum RFQStatus {
  DRAFT           // Borrador - editable
  PUBLISHED       // Publicada - proveedores pueden cotizar
  IN_QUOTATION    // Al menos una cotización recibida
  EVALUATION      // Cerrada, en evaluación
  CLOSED          // Cerrada sin adjudicar
  AWARDED         // Adjudicada
  PO_GENERATED    // OC Generada
  CANCELLED       // Cancelada
  EXPIRED         // Expirada sin adjudicación
}

model QuotationRequestItem {
  id                  String   @id @default(cuid())
  quotationRequestId  String
  quotationRequest    QuotationRequest @relation(fields: [quotationRequestId], references: [id], onDelete: Cascade)

  // Referencia al item del requerimiento original (si aplica)
  purchaseRequestItemId String?

  // Datos del item
  description     String
  quantity        Decimal  @db.Decimal(18,4)
  unit            String   @default("Unidad")
  specifications  String?  @db.Text  // Especificaciones técnicas

  // Orden de visualización
  orderIndex      Int      @default(0)

  // Cotizaciones de este item
  quotationItems  SupplierQuotationItem[]

  createdAt       DateTime @default(now())

  @@index([quotationRequestId])
  @@map("quotation_request_items")
}

model QuotationRequestSupplier {
  id                  String   @id @default(cuid())
  quotationRequestId  String
  quotationRequest    QuotationRequest @relation(fields: [quotationRequestId], references: [id], onDelete: Cascade)

  supplierId          String
  supplier            Supplier @relation(fields: [supplierId], references: [id])

  // Estado de la invitación
  status              RFQInvitationStatus @default(PENDING)

  // Fechas de tracking
  invitedAt           DateTime @default(now())
  viewedAt            DateTime?  // Primera vez que vio la RFQ
  respondedAt         DateTime?  // Cuando envió cotización o declinó
  declineReason       String?

  // Email de notificación
  notificationSent    Boolean  @default(false)
  notificationSentAt  DateTime?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([quotationRequestId, supplierId])
  @@index([quotationRequestId])
  @@index([supplierId])
  @@map("quotation_request_suppliers")
}

enum RFQInvitationStatus {
  PENDING     // Agregado pero aún no enviado
  INVITED     // Invitado, aún no vio
  VIEWED      // Vio la solicitud
  QUOTED      // Envió cotización
  DECLINED    // Declinó participar
  AWARDED     // Ganó la licitación
  NOT_AWARDED // No ganó
}

model SupplierQuotation {
  id                  String   @id @default(cuid())
  number              String   // COT-2025-XXXXX
  quotationRequestId  String
  quotationRequest    QuotationRequest @relation(fields: [quotationRequestId], references: [id], onDelete: Cascade)

  supplierId          String
  supplier            Supplier @relation(fields: [supplierId], references: [id])

  // Estado
  status              QuotationStatus @default(DRAFT)

  // Vigencia de la cotización
  validUntil          DateTime?

  // Condiciones ofrecidas
  deliveryDays        Int?              // Días de entrega
  paymentTerms        String?           // Condiciones de pago ofrecidas
  warranty            String?           // Garantía ofrecida

  // Montos
  subtotal            Decimal  @db.Decimal(18,2)
  taxAmount           Decimal  @db.Decimal(18,2) @default(0)
  totalAmount         Decimal  @db.Decimal(18,2)
  currency            String   @default("ARS")

  // Notas y observaciones
  notes               String?  @db.Text
  internalNotes       String?  @db.Text  // Notas internas del comprador

  // Adjuntos (URLs JSON array)
  attachments         Json?    // [{fileName, fileUrl, fileType}]

  // Evaluación del comprador
  score               Int?     // Puntaje de evaluación (1-100)
  evaluationNotes     String?  @db.Text

  // Adjudicación
  isWinner            Boolean  @default(false)
  awardedAt           DateTime?
  awardedById         String?
  awardReason         String?  @db.Text

  // OC generada (si ganó)
  generatedPOId       String?

  // Items cotizados
  items               SupplierQuotationItem[]

  // Fechas
  submittedAt         DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([quotationRequestId, supplierId])
  @@index([quotationRequestId])
  @@index([supplierId])
  @@index([status])
  @@map("supplier_quotations")
}

enum QuotationStatus {
  DRAFT       // Borrador del proveedor
  SUBMITTED   // Enviada por el proveedor
  UNDER_REVIEW // En revisión por el comprador
  ACCEPTED    // Aceptada pero no ganadora
  AWARDED     // Adjudicada/Ganadora
  REJECTED    // Rechazada
  EXPIRED     // Expirada (pasó validUntil)
}

model SupplierQuotationItem {
  id                    String   @id @default(cuid())
  supplierQuotationId   String
  supplierQuotation     SupplierQuotation @relation(fields: [supplierQuotationId], references: [id], onDelete: Cascade)

  // Referencia al item solicitado
  quotationRequestItemId String
  quotationRequestItem   QuotationRequestItem @relation(fields: [quotationRequestItemId], references: [id])

  // Datos cotizados
  unitPrice             Decimal  @db.Decimal(18,4)
  quantity              Decimal  @db.Decimal(18,4)  // Puede diferir de lo solicitado
  totalPrice            Decimal  @db.Decimal(18,4)

  // Detalles adicionales
  brand                 String?   // Marca ofrecida
  model                 String?   // Modelo ofrecido
  partNumber            String?   // Número de parte
  notes                 String?   // Notas sobre el item

  // Alternativa (si ofrece algo diferente)
  isAlternative         Boolean  @default(false)
  alternativeDescription String?

  createdAt             DateTime @default(now())

  @@index([supplierQuotationId])
  @@index([quotationRequestItemId])
  @@map("supplier_quotation_items")
}

// ============================================
// CHAT INTERNO DE REQUERIMIENTOS
// ============================================

model PurchaseRequestChat {
  id                    String   @id @default(cuid())
  purchaseRequestId     String   @unique
  purchaseRequest       PurchaseRequest @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  messages              PurchaseRequestChatMessage[]
  userReadStatus        PurchaseRequestChatReadStatus[]

  @@index([purchaseRequestId])
  @@map("purchase_request_chats")
}

model PurchaseRequestChatMessage {
  id                    String   @id @default(cuid())
  chatId                String
  chat                  PurchaseRequestChat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  senderId              String
  senderName            String
  senderRole            String   // 'SOLICITANTE' | 'APROBADOR'

  text                  String   @db.Text
  attachments           Json?    // [{fileName, fileUrl, fileType, fileSize}]

  createdAt             DateTime @default(now())

  @@index([chatId, createdAt])
  @@map("purchase_request_chat_messages")
}

model PurchaseRequestChatReadStatus {
  id                    String   @id @default(cuid())
  chatId                String
  chat                  PurchaseRequestChat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  userId                String
  lastReadAt            DateTime @default(now())
  lastReadMessageId     String?

  @@unique([chatId, userId])
  @@index([userId])
  @@map("purchase_request_chat_read_status")
}
