// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTENTICACIÓN Y USUARIOS
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String
  phone         String?
  avatar        String?
  emailVerified Boolean   @default(false)
  superuser     Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Multi-tenant
  tenantMemberships TenantMembership[]

  // Actividad
  uploadedDocuments  Document[]       @relation("UploadedDocuments")
  documentEvents     DocumentEvent[]
  comments           Comment[]

  // Purchase Requests
  purchaseRequests   PurchaseRequest[] @relation("PurchaseRequestSolicitante")
  purchaseRequestsAprobados PurchaseRequest[] @relation("PurchaseRequestAprobador")
  attachmentsAprobados PurchaseRequestAttachment[]

  @@index([email])
}

model Tenant {
  id          String   @id @default(cuid())
  name        String
  legalName   String
  taxId       String   @unique // CUIT, RUT, etc.
  country     String
  address     String?
  phone       String?
  email       String?
  website     String?
  settings    Json     @default("{}")
  branding    Json?    // Logo, colores personalizados
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  memberships TenantMembership[]

  // Como cliente (recibe documentos)
  documentsReceived Document[]       @relation("ClientDocuments")
  purchaseOrders    PurchaseOrder[]
  paymentsIssued    Payment[]

  // Como proveedor (envía documentos)
  documentsSent     Document[]       @relation("ProviderDocuments")
  paymentsReceived  Payment[]        @relation("ReceivedPayments")

  // Menu items personalizados
  menuItems         MenuItem[]

  // Purchase Requests
  purchaseRequests  PurchaseRequest[]

  @@index([taxId])
  @@index([isActive])
}

model TenantMembership {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String
  roles     Role[]
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata de invitación
  invitedBy String?
  invitedAt DateTime?
  joinedAt  DateTime?

  @@unique([userId, tenantId])
  @@index([userId])
  @@index([tenantId])
}

enum Role {
  PROVIDER              // Puede cargar documentos
  CLIENT_VIEWER         // Solo ver documentos
  CLIENT_APPROVER       // Aprobar/rechazar documentos
  CLIENT_ADMIN          // Gestión completa
  SUPER_ADMIN           // Admin global del sistema
  // Roles de Compras
  PURCHASE_REQUESTER    // Puede crear requerimientos de compra
  PURCHASE_APPROVER     // Puede aprobar requerimientos de compra
  PURCHASE_ADMIN        // Gestión completa del circuito de compras
}

// ============================================
// DOCUMENTOS
// ============================================

model Document {
  id        String   @id @default(cuid())
  number    String
  type      DocumentType
  status    DocumentStatus

  // Montos
  amount      Decimal
  taxAmount   Decimal
  totalAmount Decimal
  currency    String   @default("ARS")

  // Archivo
  fileUrl     String
  fileName    String
  fileType    String
  fileSize    Int

  // Multi-tenant
  providerTenantId String
  providerTenant   Tenant @relation("ProviderDocuments", fields: [providerTenantId], references: [id])

  clientTenantId   String
  clientTenant     Tenant @relation("ClientDocuments", fields: [clientTenantId], references: [id])

  // Usuario que subió
  uploadedBy       String
  uploader         User   @relation("UploadedDocuments", fields: [uploadedBy], references: [id])

  // Fechas
  date             DateTime?  // Fecha del documento
  dueDate          DateTime?  // Fecha de vencimiento
  uploadedAt       DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  // Parse integration
  parseJobId       String?
  parseDocumentId  String?      // ID del documento en Parse (documentos_procesados.id)
  parseStatus      ParseStatus  @default(PENDING)
  parseData        Json?
  parseConfidence  Decimal?
  parseError       String?
  parseRawText     String?      @db.Text
  parsedAt         DateTime?

  // Relaciones
  purchaseOrderId  String?
  purchaseOrder    PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])

  timeline         DocumentEvent[]
  comments         Comment[]
  attachments      Attachment[]
  paymentItems     PaymentItem[]

  @@unique([number, providerTenantId, clientTenantId])
  @@index([providerTenantId, clientTenantId, status])
  @@index([clientTenantId, status, uploadedAt])
  @@index([parseStatus])
}

enum DocumentType {
  INVOICE
  CREDIT_NOTE
  DEBIT_NOTE
  RECEIPT
}

enum DocumentStatus {
  PROCESSING   // Subido, esperando Parse
  PRESENTED    // Presentado, esperando revisión
  IN_REVIEW    // En proceso de revisión
  APPROVED     // Aprobado
  PAID         // Pagado
  REJECTED     // Rechazado
}

enum ParseStatus {
  PENDING
  PROCESSING
  COMPLETED
  ERROR
}

model DocumentEvent {
  id          String   @id @default(cuid())
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  fromStatus  DocumentStatus?
  toStatus    DocumentStatus
  reason      String?
  metadata    Json?

  userId      String
  user        User     @relation(fields: [userId], references: [id])

  createdAt   DateTime @default(now())

  @@index([documentId, createdAt])
}

model Comment {
  id          String   @id @default(cuid())
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  userId      String
  user        User     @relation(fields: [userId], references: [id])

  text        String   @db.Text
  attachments Attachment[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([documentId, createdAt])
}

model Attachment {
  id         String   @id @default(cuid())
  fileUrl    String
  fileName   String
  fileType   String
  fileSize   Int

  documentId String?
  document   Document? @relation(fields: [documentId], references: [id], onDelete: Cascade)

  commentId  String?
  comment    Comment?  @relation(fields: [commentId], references: [id], onDelete: Cascade)

  uploadedAt DateTime @default(now())

  @@index([documentId])
  @@index([commentId])
}

// ============================================
// MENU DINÁMICO
// ============================================

model MenuItem {
  id                 String       @id @default(cuid())
  parentId           String?
  title              String       @db.VarChar(100)
  icon               String       @db.VarChar(50)
  url                String?      @db.VarChar(255)
  description        String?      @db.VarChar(500)
  orderIndex         Int          @default(0)
  isActive           Boolean      @default(true)
  requiresPermission String?      @db.VarChar(100)
  superuserOnly      Boolean      @default(false)
  tenantId           String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  createdBy          String?
  updatedBy          String?

  parent             MenuItem?    @relation("MenuHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children           MenuItem[]   @relation("MenuHierarchy")
  tenant             Tenant?      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([orderIndex])
  @@index([parentId])
  @@index([superuserOnly])
  @@index([tenantId])
  @@map("menu_items")
}

// ============================================
// ÓRDENES DE COMPRA (CIRCUITO DE COMPRAS)
// ============================================

model PurchaseOrderCircuit {
  id                String    @id @default(cuid())
  numero            String    // OC-2025-XXXXX

  // Vínculo con el requerimiento (one-to-many: un requerimiento puede tener múltiples OCs)
  purchaseRequestId String
  purchaseRequest   PurchaseRequest @relation(fields: [purchaseRequestId], references: [id])

  // Proveedor
  proveedorId       String
  proveedor         Supplier  @relation(fields: [proveedorId], references: [id])

  // Estado
  estado            PurchaseOrderCircuitStatus @default(PENDIENTE_APROBACION)

  // Montos
  subtotal          Decimal   @db.Decimal(18,2)
  impuestos         Decimal   @db.Decimal(18,2) @default(0)
  total             Decimal   @db.Decimal(18,2)
  moneda            String    @default("ARS")

  // Condiciones
  condicionPago     String?
  lugarEntrega      String?
  observaciones     String?   @db.Text

  // Fechas
  fechaEmision      DateTime  @default(now())
  fechaEntregaEstimada DateTime?

  // Multi-tenant
  tenantId          String

  // Usuario que creó la OC
  creadoPorId       String

  // Aprobación de OC
  aprobadorOCId     String?
  fechaAprobacionOC DateTime?
  comentarioAprobacionOC String? @db.Text

  // Items
  items             PurchaseOrderItem[]

  // Recepciones
  recepciones       Reception[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([numero, tenantId])
  @@index([tenantId, estado])
  @@index([purchaseRequestId])
  @@index([proveedorId])
  @@map("purchase_order_circuits")
}

model PurchaseOrderItem {
  id                  String    @id @default(cuid())
  purchaseOrderId     String
  purchaseOrder       PurchaseOrderCircuit @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  // Referencia al item original del requerimiento
  purchaseRequestItemId String?
  purchaseRequestItem   PurchaseRequestItem? @relation(fields: [purchaseRequestItemId], references: [id])

  descripcion         String
  cantidad            Decimal   @db.Decimal(18,4)
  cantidadRecibida    Decimal   @db.Decimal(18,4) @default(0)
  unidad              String    @default("Unidad")
  precioUnitario      Decimal   @db.Decimal(18,4)
  total               Decimal   @db.Decimal(18,4)

  createdAt           DateTime  @default(now())

  // Items recibidos en recepciones
  itemsRecibidos      ReceptionItem[]

  @@index([purchaseOrderId])
  @@index([purchaseRequestItemId])
  @@map("purchase_order_items")
}

enum PurchaseOrderCircuitStatus {
  PENDIENTE_APROBACION
  APROBADA
  RECHAZADA
  EN_PROCESO
  PARCIALMENTE_RECIBIDA
  ENTREGADA
  FINALIZADA
  CANCELADA
}

// ============================================
// PROVEEDORES
// ============================================

model Supplier {
  id          String    @id @default(cuid())
  tenantId    String

  nombre      String
  cuit        String
  direccion   String?
  telefono    String?
  email       String?
  contacto    String?

  isActive    Boolean   @default(true)

  // Órdenes de compra
  ordenesCompra PurchaseOrderCircuit[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([tenantId, cuit])
  @@index([tenantId, isActive])
  @@map("suppliers")
}

// ============================================
// RECEPCIONES
// ============================================

model Reception {
  id                String    @id @default(cuid())
  numero            String    // REC-2025-XXXXX

  // Vínculos
  purchaseOrderId   String
  purchaseOrder     PurchaseOrderCircuit @relation(fields: [purchaseOrderId], references: [id])

  // Receptor
  receptorId        String

  // Datos de recepción
  fechaRecepcion    DateTime  @default(now())
  tipoRecepcion     ReceptionType @default(TOTAL)
  observaciones     String?   @db.Text

  // Multi-tenant
  tenantId          String

  // Items recibidos
  itemsRecibidos    ReceptionItem[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([numero, tenantId])
  @@index([tenantId])
  @@index([purchaseOrderId])
  @@map("receptions")
}

model ReceptionItem {
  id                String    @id @default(cuid())
  receptionId       String
  reception         Reception @relation(fields: [receptionId], references: [id], onDelete: Cascade)

  // Vínculo con item de OC
  purchaseOrderItemId String
  purchaseOrderItem   PurchaseOrderItem @relation(fields: [purchaseOrderItemId], references: [id])

  descripcion       String
  unidad            String
  cantidadEsperada  Decimal   @db.Decimal(18,4)
  cantidadRecibida  Decimal   @db.Decimal(18,4)
  cantidadPendiente Decimal   @db.Decimal(18,4)

  createdAt         DateTime  @default(now())

  @@index([receptionId])
  @@index([purchaseOrderItemId])
  @@map("reception_items")
}

enum ReceptionType {
  TOTAL
  PARCIAL
}

// ============================================
// ÓRDENES DE COMPRA (LEGACY - para documentos)
// ============================================

model PurchaseOrder {
  id             String    @id @default(cuid())
  number         String
  description    String?
  amount         Decimal
  currency       String    @default("ARS")
  status         PurchaseOrderStatus

  clientTenantId String
  clientTenant   Tenant    @relation(fields: [clientTenantId], references: [id])

  // Fechas
  date           DateTime
  dueDate        DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Archivo
  fileUrl        String?
  fileName       String?

  // Relaciones
  documents      Document[]

  @@unique([number, clientTenantId])
  @@index([clientTenantId, status])
}

enum PurchaseOrderStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

// ============================================
// PAGOS
// ============================================

model Payment {
  id              String   @id @default(cuid())
  number          String
  amount          Decimal
  currency        String   @default("ARS")
  status          PaymentStatus

  // Tenant que emite el pago
  issuedByTenantId String
  issuedByTenant   Tenant @relation(fields: [issuedByTenantId], references: [id])

  // Tenant que recibe el pago
  receivedByTenantId String
  receivedByTenant   Tenant @relation("ReceivedPayments", fields: [receivedByTenantId], references: [id])

  // Fechas
  issueDate       DateTime
  scheduledDate   DateTime?
  paidAt          DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Archivos
  receiptUrl      String?
  retentionUrls   Json?     // Array de URLs de retenciones

  // Documentos incluidos en el pago
  items           PaymentItem[]

  @@unique([number, issuedByTenantId])
  @@index([issuedByTenantId, status])
  @@index([receivedByTenantId, status])
}

enum PaymentStatus {
  SCHEDULED
  PROCESSING
  PAID
  FAILED
}

model PaymentItem {
  id         String  @id @default(cuid())
  paymentId  String
  payment    Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  documentId String
  document   Document @relation(fields: [documentId], references: [id])

  amount     Decimal

  @@index([paymentId])
  @@index([documentId])
}

// ============================================
// COMUNICACIONES
// ============================================

model Conversation {
  id              String   @id @default(cuid())
  subject         String
  status          ConversationStatus
  channel         CommunicationChannel

  // Participantes
  providerTenantId String
  clientTenantId   String

  createdById     String
  closedById      String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  closedAt        DateTime?

  messages        Message[]

  @@index([providerTenantId, clientTenantId])
  @@index([status])
}

enum ConversationStatus {
  OPEN
  RESOLVED
  CLOSED
}

enum CommunicationChannel {
  PORTAL
  EMAIL
  WHATSAPP
  SMS
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderId       String
  text           String       @db.Text
  channel        CommunicationChannel

  readAt         DateTime?
  createdAt      DateTime     @default(now())

  @@index([conversationId, createdAt])
}

// ============================================
// NOTIFICACIONES
// ============================================

model Notification {
  id        String            @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String            @db.Text
  data      Json?
  channel   CommunicationChannel

  readAt    DateTime?
  sentAt    DateTime?
  createdAt DateTime          @default(now())

  @@index([userId, readAt])
}

enum NotificationType {
  DOCUMENT_UPLOADED
  DOCUMENT_PARSED
  DOCUMENT_STATUS_CHANGED
  PAYMENT_ISSUED
  MESSAGE_RECEIVED
  APPROVAL_REQUIRED
}

// ============================================
// MÓDULO DE COMPRAS - REQUERIMIENTOS
// ============================================

model PurchaseRequest {
  id          String                @id @default(cuid())
  numero      String                // REQ-2025-XXXXX (único por tenant)
  titulo      String                // Título corto generado del primer item

  // Estado
  estado      PurchaseRequestStatus @default(BORRADOR)
  prioridad   PurchaseRequestPriority @default(NORMAL)

  // Tipo de compra (para determinar regla de aprobación)
  purchaseType  PurchaseType          @default(DIRECT)

  // Switch de aprobación de especificaciones
  requiresSpecApproval  Boolean       @default(false)
  specsApproved         Boolean       @default(false)  // True cuando las especificaciones fueron aprobadas

  // Datos del requerimiento
  categoria     String                // Tecnología, Oficina, Servicios, etc.
  centroCostos  String?               // Centro de costos
  justificacion String?               @db.Text

  // Montos
  montoEstimado Decimal?            // Presupuesto estimado
  currency      String              @default("ARS")

  // Multi-tenant
  tenantId    String
  tenant      Tenant                @relation(fields: [tenantId], references: [id])

  // Usuario solicitante
  solicitanteId String
  solicitante   User                @relation("PurchaseRequestSolicitante", fields: [solicitanteId], references: [id])

  // Aprobación
  aprobadorId         String?
  aprobador           User?          @relation("PurchaseRequestAprobador", fields: [aprobadorId], references: [id])
  fechaAprobacion     DateTime?
  comentarioAprobador String?        @db.Text

  // Items del requerimiento
  items       PurchaseRequestItem[]

  // Adjuntos
  adjuntos    PurchaseRequestAttachment[]

  // Órdenes de compra generadas (puede haber múltiples OCs por requerimiento)
  ordenesCompra PurchaseOrderCircuit[]

  // Metadata del chatbot (si fue creado por IA)
  creadoPorIA Boolean               @default(false)
  promptOriginal String?            @db.Text // Comando original del usuario

  // Fechas
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  fechaNecesidad DateTime?             // Fecha en que se necesita
  fechaEnvio     DateTime?             // Fecha de envío a aprobación

  @@index([tenantId, estado])
  @@index([solicitanteId])
  @@unique([tenantId, numero])
}

model PurchaseRequestItem {
  id                String         @id @default(cuid())
  purchaseRequestId String
  purchaseRequest   PurchaseRequest @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)

  descripcion       String
  cantidad          Decimal        @db.Decimal(18,4)
  especificaciones  String?        @db.Text // JSON array de specs

  unidadMedida      String?        // unidad, paquete, servicio, etc.
  precioEstimado    Decimal?       @db.Decimal(18,4)

  createdAt         DateTime       @default(now())

  // Items de OC que referencian este item
  ordenCompraItems  PurchaseOrderItem[]

  @@index([purchaseRequestId])
}

model PurchaseRequestAttachment {
  id                String         @id @default(cuid())
  purchaseRequestId String
  purchaseRequest   PurchaseRequest @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)

  nombre            String
  tipo              String         // MIME type
  tamanio           Int            // Tamaño en bytes
  url               String         // URL del archivo

  esEspecificacion  Boolean        @default(false) // Es documento de especificaciones técnicas
  estado            AttachmentStatus @default(PENDIENTE)

  // Aprobación de especificación
  aprobadorId       String?
  aprobador         User?          @relation(fields: [aprobadorId], references: [id])
  fechaAprobacion   DateTime?
  comentario        String?

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([purchaseRequestId])
  @@map("purchase_request_attachments")
}

enum AttachmentStatus {
  PENDIENTE
  APROBADO
  RECHAZADO
}

enum PurchaseRequestStatus {
  BORRADOR
  PENDIENTE_APROBACION
  ENVIADO
  EN_REVISION
  APROBADO
  RECHAZADO
  OC_GENERADA
  RECIBIDO
  CANCELADO
}

enum PurchaseRequestPriority {
  BAJA
  NORMAL
  ALTA
  URGENTE
}

// Tipo de compra (para determinar regla de aprobación)
enum PurchaseType {
  DIRECT          // Compra directa (sin cotización)
  WITH_QUOTE      // Con cotización
  WITH_BID        // Con licitación
  WITH_ADVANCE    // Con anticipo
}

// ============================================
// SISTEMA DE NOTIFICACIONES - PREFERENCIAS
// ============================================

model UserNotificationPreference {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String

  eventType NotificationEventType
  documentType DocumentNotificationType?

  emailEnabled    Boolean @default(true)
  portalEnabled   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, tenantId, eventType, documentType])
  @@index([userId, tenantId])
  @@map("user_notification_preferences")
}

enum NotificationEventType {
  // Requerimientos
  REQ_SUBMITTED
  REQ_APPROVED
  REQ_REJECTED
  REQ_NEEDS_APPROVAL

  // Órdenes de Compra
  OC_GENERATED
  OC_NEEDS_APPROVAL
  OC_APPROVED
  OC_REJECTED

  // Recepciones
  RECEPTION_REGISTERED
  RECEPTION_COMPLETE

  // Delegaciones
  DELEGATION_RECEIVED
  DELEGATION_EXPIRED
}

enum DocumentNotificationType {
  PURCHASE_REQUEST
  PURCHASE_ORDER
  RECEPTION
  ALL
}

// ============================================
// SISTEMA DE NOTIFICACIONES - PLANTILLAS EMAIL
// ============================================

model EmailTemplate {
  id        String   @id @default(cuid())
  tenantId  String?

  eventType NotificationEventType

  subject   String
  bodyHtml  String   @db.Text
  bodyText  String?  @db.Text

  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, eventType])
  @@map("email_templates")
}

// ============================================
// SISTEMA DE NOTIFICACIONES - COLA DE EMAILS
// ============================================

model EmailQueue {
  id          String   @id @default(cuid())

  toEmail     String
  toName      String?

  subject     String
  bodyHtml    String   @db.Text
  bodyText    String?  @db.Text

  eventType   NotificationEventType
  relatedId   String?
  relatedType String?

  status      EmailQueueStatus @default(PENDING)
  attempts    Int      @default(0)
  maxAttempts Int      @default(3)
  lastError   String?
  sentAt      DateTime?

  scheduledFor DateTime @default(now())

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status, scheduledFor])
  @@map("email_queue")
}

enum EmailQueueStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
  CANCELLED
}

// ============================================
// SISTEMA DE AUTORIZACIONES - REGLAS
// ============================================

model ApprovalRule {
  id          String   @id @default(cuid())
  tenantId    String

  name        String
  description String?

  // Condiciones para aplicar esta regla
  purchaseType    PurchaseType?
  minAmount       Decimal?          @db.Decimal(18,2)
  maxAmount       Decimal?          @db.Decimal(18,2)
  category        String?

  // Prioridad (mayor = se evalúa primero)
  priority    Int      @default(0)
  isActive    Boolean  @default(true)

  // Niveles de aprobación
  levels      ApprovalLevel[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId, isActive, priority])
  @@map("approval_rules")
}

// ============================================
// SISTEMA DE AUTORIZACIONES - NIVELES
// ============================================

model ApprovalLevel {
  id              String   @id @default(cuid())
  approvalRuleId  String
  approvalRule    ApprovalRule @relation(fields: [approvalRuleId], references: [id], onDelete: Cascade)

  levelOrder      Int
  name            String

  // Modo: ANY = cualquiera aprueba (concurrente), ALL = todos aprueban (secuencial)
  approvalMode    ApprovalMode @default(ANY)

  // Tipo de nivel (general o especificaciones)
  levelType       ApprovalLevelType @default(GENERAL)

  // Aprobadores de este nivel
  approvers       ApprovalLevelApprover[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([approvalRuleId, levelOrder])
  @@map("approval_levels")
}

enum ApprovalMode {
  ANY   // Cualquiera de los aprobadores puede aprobar (OR)
  ALL   // Todos los aprobadores deben aprobar (AND)
}

enum ApprovalLevelType {
  GENERAL         // Aprobación general del documento
  SPECIFICATIONS  // Aprobación de especificaciones técnicas
}

// ============================================
// SISTEMA DE AUTORIZACIONES - APROBADORES POR NIVEL
// ============================================

model ApprovalLevelApprover {
  id                String   @id @default(cuid())
  approvalLevelId   String
  approvalLevel     ApprovalLevel @relation(fields: [approvalLevelId], references: [id], onDelete: Cascade)

  // Puede ser usuario específico o rol
  userId            String?
  role              Role?

  // Orden dentro del nivel (para modo ALL secuencial)
  sequenceOrder     Int      @default(0)

  createdAt         DateTime @default(now())

  @@map("approval_level_approvers")
}

// ============================================
// SISTEMA DE AUTORIZACIONES - WORKFLOW (instancia)
// ============================================

model ApprovalWorkflow {
  id              String   @id @default(cuid())

  // Documento asociado
  documentType    ApprovalDocumentType
  documentId      String
  tenantId        String

  // Regla que se aplicó
  approvalRuleId  String

  // Estado general del workflow
  status          ApprovalWorkflowStatus @default(PENDING)
  currentLevel    Int      @default(1)

  // Instancias de aprobación
  approvals       ApprovalInstance[]

  // Metadata
  initiatedBy     String
  initiatedAt     DateTime @default(now())
  completedAt     DateTime?

  // Resultado final
  finalDecision   ApprovalDecision?
  finalComment    String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([documentType, documentId])
  @@index([tenantId, status])
  @@map("approval_workflows")
}

enum ApprovalDocumentType {
  PURCHASE_REQUEST
  PURCHASE_ORDER
}

enum ApprovalWorkflowStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
  CANCELLED
}

// ============================================
// SISTEMA DE AUTORIZACIONES - INSTANCIA DE APROBACIÓN
// ============================================

model ApprovalInstance {
  id              String   @id @default(cuid())
  workflowId      String
  workflow        ApprovalWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  // Nivel
  levelOrder      Int
  levelName       String
  levelType       ApprovalLevelType @default(GENERAL)
  approvalMode    ApprovalMode

  // Aprobadores potenciales (para registro en modo ANY)
  potentialApprovers Json?   // [{userId, role, name}]

  // Aprobador que tomó la decisión
  decidedById     String?
  decidedByName   String?

  // Decisión
  decision        ApprovalDecision @default(PENDING)
  comment         String?

  // Fechas
  assignedAt      DateTime @default(now())
  decidedAt       DateTime?
  dueDate         DateTime?

  // Delegación (si aplica)
  delegatedFromId String?
  delegatedAt     DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([workflowId, levelOrder])
  @@index([decidedById, decision])
  @@map("approval_instances")
}

enum ApprovalDecision {
  PENDING
  APPROVED
  REJECTED
  DELEGATED
  SKIPPED
}

// ============================================
// SISTEMA DE AUTORIZACIONES - DELEGACIONES
// ============================================

model ApprovalDelegation {
  id              String   @id @default(cuid())
  tenantId        String

  // Quien delega
  delegatorId     String
  delegatorName   String

  // A quien delega
  delegateId      String
  delegateName    String

  // Periodo de vigencia
  startDate       DateTime
  endDate         DateTime

  reason          String?
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId, delegatorId, isActive])
  @@index([delegateId, isActive])
  @@map("approval_delegations")
}

